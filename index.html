<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>幸运抽奖大转盘</title>
  <link rel="stylesheet" href="./css/reset.css"/>
  <link rel="stylesheet" href="./css/index.css"/>
</head>
<body>
  <main>
    <!-- logo -->
    <header>
      <div class="header-left">
        <img src="./image/logo.png" alt="光大银行" />
      </div>
      <div class="header-right">
        <span id="rules">活动规则</span>
        <i class="line"></i>
        <span id="ranking">中奖名单</span>
      </div>
    </header>
    <!-- 标题 -->
    <div class="title ">
      <img src="./image/title.png" alt="看直播送礼品">
    </div>
    <!-- 转盘 -->
    <div class="pie-baic">
      <img src="./image/red-box-4.png" alt="红包4" class="red-box-1" />
      <img src="./image/red-box-3.png" alt="红包3" class="red-box-2" />
      <div class="pie-box">
        <div class="pie" id="pieDisc">
          <!-- 奖品 -->
          <!-- <div class="pie-prize">
            <span>一等奖</span>
            <img src="" alt="" />
          </div> -->
        </div>
        <div class="btn" id="btnStart">
          <img src="./image/needle.png" alt="开始抽奖"/>
        </div>

      </div>
    </div>
    <!--抽奖次数  -->
    <div class="play-eg">
      您还有
      <span>1</span>
      次游戏机会
    </div>
    <!-- 我的奖品 -->
    <div class="prize-me-show" onclick="getMePrize()">
      我的奖品
    </div>
    <!-- 奖品展示 -->
    <div class="prize-show">
      <img src="./image/red-box-2.png" alt="红包2" class="red-box-1"/>
      <img src="./image/red-box-1.png" alt="红包1" class="red-box-2"/>
      <div class="prize-show-live">
        <span>直播奖品:</span>
      </div>  
    </div>      
  </main>
  <!-- 遮罩层 -->
  <div class="mask" id="maskId">
    <!-- 活动规则 -->
    <div class="rules-show" id="rules_show">
      <div class="rules-show-title">
        <img src="./image/rules.png" alt="活动规则"/>
      </div>
      <div class="rules-show-content">
          <div class="rules-show-txt">
            <h3>活动奖品:</h3>
            <ul class="ul-style">
              <li>签名书一本</li>
              <li>保温壶一个</li>
              <li>手宝一个</li>
              <li>定制手账本一个</li>
            </ul>
            <h3>活动时间:</h3>
            <ul >
              <li><span>游戏时间:</span> 2020年12月28日 （仅限直播当日）</li>
              <li><span>发奖时间:</span> 银行将在整理中奖信息后,统一邮寄</li>
            </ul>
            <h3>活动说明:</h3>
            <ul class="ul-style">
              <li>点击转盘中奖按钮,即可开始游戏;</li>
              <li>参与直播的用户，每轮均可参加,最多可获得一份奖品;</li>
              <li>若玩家没有提交个人信息,则视为放弃所获奖品;</li>
              <li>奖品将根据用户填写的地址进行邮寄,无需前往银行柜台领取</li>
            </ul>
          </div>
          <img src="./image/red-box-4.png" alt="红包4" class="red-box-1">
          <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
          <img src="./image/red-box-3.png" alt="红包3" class="red-box-3">
      </div>
    </div>
    <!-- 中奖名单 -->
    <div class="ranking-show rules-show" id="ranking_show">
      <div class="ranking-show-title rules-show-title">
        <img src="./image/ranking.png" alt="中奖名单"/>
      </div>
      <div class="ranking-show-content rules-show-content">
        <div class="ranking-show-list rules-show-txt">
          <div class="list-tip">
              <span>序号</span>
              <span>名称</span>
              <span>奖品</span>
          </div>
          <ul id="ranking-list"></ul>
        </div>
        <img src="./image/red-box-4.png" alt="红包4" class="red-box-1">
        <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
        <img src="./image/red-box-3.png" alt="红包3" class="red-box-3">
      </div>
      
    </div>
    <!-- 没有游戏机会 -->
    <div class="no-chance rules-show" id="no_chance">
      <div class="no-chance-content rules-show-content">
        <div class="no-chance-txt rules-show-txt">您的游戏机会已用完</div>
      </div>
      <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
      <img src="./image/red-box-3.png" alt="红包3" class="red-box-1">
      <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
    </div>
    <!-- 我的奖品 -->
    <div class="mePrize rules-show no-chance" id="me_prize">
      <!-- 无奖品显示 （活动结束显示 ：奖品已发完 / 未获得奖品显示：您暂未获得奖品） -->
      <div class="mePrize-content no-chance-content rules-show-content" >
        <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
        <div class="mePrize-txt no-chance-txt rules-show-txt">您暂未获得奖品<br/>请再接再厉</div>
      </div>
      <!-- 有奖品显示 -->
      <div class="mePrize-copone" style="display: none;">
        <div class="mePrize-copone-content rules-show-content">
          <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
          <div class="mePrize-copone-imges"></div>
        </div>
        <!-- 卡券显示 -->
        <div class="mePrize-coupon-ma" >
          <span>卡券编码:</span>
          <p>卡券编码显示位</p>
        </div>
        <!-- 卡券说明 -->
        <div class="mePrize-coupon-rules rules-show-content" >
          <div class="mePrize-copone-rules-txt">
            <h3>活动说明:</h3>
            <ul>
              <li>微信小程序或滴滴APP扫码免费骑行30天,每天可骑行20次。</li>
              <li>月卡剩余天数小于30天可免费领取。当前若无月卡，领取后
                立即生效；当前若已有月卡，领取后有效期顺延；</li>
              <li>已领取的月卡可在【滴滴APP】或【青桔单车小程序】查看。</li>
              <li>单车月卡生效期间，每次行程前5小时免费，5小时后正常计
                费。月卡是否可用，以落锁时月卡状态为准。</li>
              <li>单车月卡仅可抵扣骑行青桔单车、小蓝单车产生的费用。</li>
              <li>当前若无月卡，领取后月卡立即生效；当前若已有月卡，领取
                后有效期顺延。</li>
              <li>已领取的月卡可在【滴滴客户端】-【我的】-【钱包】中查看，
                请升级至最新版客户端查看和使用（V5.2.0及以上版本）。</li>
            </ul>
          </div>
        </div>
        <!-- 非卡券显示 -->
        <div class="mePrize-coupon-rules-goods-txt" style="display: none;">
          <h3>派送方式</h3>
          <p>直播结束三日后, 银行工作人员将会致电,确认无误后会根据所填地址进行邮寄。</p>
        </div>
      </div>
      
    </div>
  </div>
  
  <script src="./js/flexible/flexible.js"></script>
  <script src="./js/CryptoJS.min.js"></script>
  <script src="./js/secret.js"></script>
  <script src="./js/axios.min.js"></script>
  <script>
    let APIURL = 'http://114.116.17.81:8234';

    let API = {
      login:'/login/'
    }

    // {
    //   // 请求简易封装
    //  async function Ajax(data,path,url,async) {
    //     let xhr = new XMLHttpRequest();
    //     xhr.open(path,url,async);
    //     xhr.onreadystatechange = function (e) {
    //       if(xhr.status === 200 && xhr.readyState === 4){
    //         console.log(e)
    //         console.log(Decrypt (xhr.responseText),'ok')
    //         return xhr.responseText;
    //       }
    //     }
    //     xhr.onerror = function () {
    //       console.log(Decrypt (xhr.responseText),'error')
    //       return xhr.responseText
    //     }
    //     xhr.send(data);
    //   }
    //   let code = '7knsTZjahxxoi4CQejtrKehcCSRE3KDFJtLtd4b'
    //   Ajax(null,'GET',APIURL + API.login + code,true);
    // }
    


    // 中奖元素添加
    let domPie = document.getElementById('pieDisc');
    
    createPrizeList(domPie,6);
    // 生成奖品
    function createPrizeList (domPie,w) {
      let R = Number(window.getComputedStyle(domPie,null).width.slice(0, -2));
      let deg = Math.PI/w ;
      let Deg_t = 360/w ;
      let WIDTH = R*Math.sin(deg);
      for(let i = 0 ; i<w ; i++){
        let rotateDeg = Deg_t*i;
        let html = `<span>谢谢参与${i}</span>
                  <img src="./image/thanks.png" alt="谢谢参与" />`
        let domItem = document.createElement('div');
        domItem.classList.add('pie-prize');
        domItem.style.width = WIDTH-30 + "px";
        domItem.style.transform =  "rotate("+ rotateDeg +"deg)";
        domItem.innerHTML = html ; 
        domPie.appendChild(domItem);
      }
      
    }

    // 遮罩元素
    let MaskDom = document.getElementById("maskId");
    MaskDom.addEventListener('click',(event)=>{
      event.currentTarget.style.display = 'none';
      document.body.classList.remove('body-disabled');
      if(flag){
        if(isPointer){
          startDom.style.transform = "rotate("+ preDeg +"deg)";
        }else{
          pieDiscDom.style.transform = "rotate("+ preDeg +"deg)";
        }
      }
    },false)
    // 活动规则 中奖名单显示 消息提示
    let rulesShow = document.getElementById('rules_show');
    let rankingShow = document.getElementById('ranking_show');
    let noChance = document.getElementById('no_chance');
    let mePrize = document.getElementById('me_prize');
    // 活动规则
    let rulesDom = document.getElementById('rules');
    rulesDom.onclick = () => {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'block';
      rankingShow.style.display = 'none';
      noChance.style.display = 'none';
      mePrize.style.display = 'none';
      document.body.classList.add('body-disabled');
    }

    // 我的奖品
    function getMePrize() {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'none';
      rankingShow.style.display = 'none';
      noChance.style.display = 'none';
      mePrize.style.display = 'block';
      document.body.classList.add('body-disabled');
    }
    // 中奖名单 
    let rankingDom = document.getElementById('ranking');
    let rankingList = document.getElementById('ranking-list');
    for(let i = 0 ; i<100 ; i++) {
      let html = `<li>
      <span>${i}</span>
      <span>名${i}称</span>
      <span>奖${i}品</span>
    </li>`;
    rankingList.innerHTML += html;
    }
    rankingDom.onclick = () => {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'none';
      rankingShow.style.display = 'block';
      noChance.style.display = 'none';
      mePrize.style.display = 'none';
      document.body.classList.add('body-disabled');
    }
    // 提示信息
    

    // 点击开始旋转
    // 旋转封装
    // {
      let prizeList = [];     //奖品数据
      let prizeNum = 6 ;      //奖品数量
      let userCount = 1 ;     //用户可用游戏次数
      let userFlag = true ;   //用户是否可以玩
      let asyncData = '' ;    //中奖数据
      let isPointer = false;  //是否指针旋转
      let rotateStyle = '';   //转盘旋转样式
      let pointerStyle = '';  //指针旋转样式
      let fixCircle = 6 ;     //转盘固定旋转圈数
      let pointerCircle = 6 ; //指针固定旋转圈数
      let flag = true ;       //节流
      let winIndex = 1 ;      // 中间索引 （下标）
      let preDeg = 0 ;        //上次游戏转盘旋转角度
      // 获取当前用户游戏次数
      function getUserCount(){
        if(userCount<1){
          userFlag = false;
        }
      }
      // 点击旋转按钮
      async function  hanldStart() {
        if(flag) return;

        flag = false;
        let winningIndex = await Ajax() ? await Ajax() : Math.floor(Math.random()*prizeNum);
      }
      // 计算旋转圈数角度
      function  countDeg(index) {
        let cycles = isPointer? pointerCircle : fixCircle;
        cycles*=360;
        // 旋转角度
        
        let cyclesDeg = ( 360/prizeNum )*index + cycles + preDeg ;
        // 记录角度
        preDeg = ( 360/prizeNum )*( prizeNum - index) + cyclesDeg;

        return cyclesDeg;
      }
    // }
    //  待更改
    let startDom = document.getElementById('btnStart');
    let pieDiscDom = document.getElementById('pieDisc');
    startDom.onclick = () => {
      if(flag){
        flag = false;
        pieDiscDom.style.transition = "transform ease 4s";
        if(isPointer) {
          startDom.style.transition = "transform ease 4s";
          startDom.style.transform = "rotate("+ countDeg(winIndex) +"deg)"+"scale(0.9)";
        }else {
          pieDiscDom.style.transform = "rotate("+ countDeg(prizeNum-winIndex) +"deg)";
        }
        setTimeout(()=>{
          pieDiscDom.style.transition = 'none';
          startDom.style.transition = 'none';
          
          flag = true;
          // 显示游戏次数不足
          MaskDom.style.display = 'block';
          rulesShow.style.display = 'none';
          rankingShow.style.display = 'none';
          noChance.style.display = 'block';
          mePrize.style.display = 'none';
          document.body.classList.add('body-disabled');
        },4100)
      }
    }
    
    



  </script>
</body>
</html>