<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta name="viewport" viewport-fit=cover>
  <meta name="apple-mobile-web-app-capable" content="yes"> <!-- apple devices fullscreen -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- iOS -- 让网页内容以应用程序风格显示，并使状态栏透明。 -->
  <title>幸运抽奖大转盘</title>
  <link rel="stylesheet" href="./css/reset.css"/>
  <link rel="stylesheet" href="./css/loading.css"/>
  <link rel="stylesheet" href="./css/index.css?v=2"/>
</head>
<body>
   <!-- loading -->
   <div class="loading">
    <div class="loading-content">
    </div>
  </div>

  <main>
    <!-- logo -->
    <header>
      <div class="header-left">
        <img src="./image/logo.png" alt="光大银行" />
      </div>
      <div class="header-right">
        <span id="rules">活动规则</span>
        <i class="line"></i>
        <span id="ranking">中奖名单</span>
      </div>
    </header>
    <!-- 标题 -->
    <div class="title ">
      <img src="./image/title.png" alt="看直播送礼品">
    </div>
    <!-- 转盘 -->
    <div class="pie-baic">
      <img src="./image/red-box-4.png" alt="红包4" class="red-box-1" />
      <img src="./image/red-box-3.png" alt="红包3" class="red-box-2" />
      <div class="pie-box">
        <div class="pie" id="pieDisc">
          <!-- 奖品 -->
          <!-- <div class="pie-prize">
            <span>一等奖</span>
            <img src="" alt="" />
          </div> -->
        </div>
        <div class="btn" id="btnStart" onclick="hanldStart()">
          <img src="./image/needle.png" alt="开始抽奖"/>
        </div>

      </div>
    </div>
    <!--抽奖次数  -->
    <div class="play-eg">
      您还有
      <span class="play-bout">1</span>
      次游戏机会
    </div>
    <!-- 我的奖品 -->
    <div class="prize-me-show" onclick="getMePrize()">
      我的奖品
    </div>
    <!-- 奖品展示 -->
    <div class="prize-show">
      <img src="./image/red-box-2.png" alt="红包2" class="red-box-1"/>
      <img src="./image/red-box-1.png" alt="红包1" class="red-box-2"/>
      <div class="prize-show-live">
        <span>直播奖品:</span>
        <div><span>一等奖:</span>小米蓝牙耳机一副。</div>
        <div><span>二等奖:</span>阿玛尼丝绒哑唇釉一支。</div>
        <div><span>三等奖:</span>小熊咖啡机一台。</div>
        <div><span>四等奖:</span>蛋糕、电影、网络视听50元通用券一张。</div>
      </div>  
    </div>      
  </main>
  <!-- 遮罩层 -->
  <div class="mask" id="maskId">
    <!-- 活动规则 -->
    <div class="rules-show" id="rules_show">
      <div class="rules-show-title">
        <img src="./image/rules.png" alt="活动规则"/>
      </div>
      <div class="rules-show-content">
          <div class="rules-show-txt">
            <h3>活动奖品:</h3>
            <ul>
              <li>一等奖: 小米蓝牙耳机一副。</li>
              <li>二等奖: 阿玛尼丝绒哑唇釉一支。</li>
              <li>三等奖: 小熊咖啡机一台。</li>
              <li>四等奖: 蛋糕、电影、网络视听50元通用券一张。</li>
            </ul>
            <h3>活动时间:</h3>
            <ul >
              <li> 2021年1月30日 （仅限直播当日）</li>
              <!-- <li><span>发奖时间:</span> 银行将在整理中奖信息后,统一邮寄</li> -->
            </ul>
            <h3>活动说明:</h3>
            <ul class="ul-style">
              <li>大转盘抽奖分多轮进行,点击转盘中间按钮,即可开始游戏;</li>
              <li>若玩家没有提交个人信息,则视为放弃所获奖品;</li>
              <li>若为实物类奖品,将根据用户填写的地址进行邮寄;若为卡券类奖品,请根据中奖页面的二维码提示进行领取使用。</li>
            </ul>
          </div>
          <img src="./image/red-box-4.png" alt="红包4" class="red-box-1">
          <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
          <img src="./image/red-box-3.png" alt="红包3" class="red-box-3">
      </div>
    </div>
    <!-- 中奖名单 -->
    <div class="ranking-show rules-show" id="ranking_show">
      <div class="ranking-show-title rules-show-title">
        <img src="./image/ranking.png" alt="中奖名单"/>
      </div>
      <div class="ranking-show-content rules-show-content">
        <div class="ranking-show-list rules-show-txt">
          <div class="list-tip">
              
              <span>用户名</span>
              <span>手机</span>
              <span>奖品</span>
          </div>
          <ul id="ranking-list"></ul>
        </div>
        <img src="./image/red-box-4.png" alt="红包4" class="red-box-1">
        <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
        <img src="./image/red-box-3.png" alt="红包3" class="red-box-3">
      </div>
      
    </div>
    <!-- 没有游戏机会 -->
    <div class="no-chance rules-show" id="no_chance">
      <div class="no-chance-content rules-show-content">
        <div class="no-chance-txt rules-show-txt">您的游戏机会已用完</div>
      </div>
      <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
      <img src="./image/red-box-3.png" alt="红包3" class="red-box-1">
      <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">
    </div>
    <!-- 我的奖品 -->
    <div class="mePrize rules-show no-chance" id="me_prize">
      <!-- 无奖品显示 （活动结束显示 ：奖品已发完 / 未获得奖品显示：您暂未获得奖品） -->
      <div class="mePrize-content no-chance-content rules-show-content noHasMePrize" >
        <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
        <div class="mePrize-txt no-chance-txt rules-show-txt">您暂未获得奖品<br/>请再接再厉</div>
      </div>
      <!-- 有奖品显示 -->
      <div class="mePrize-copone hasMePrize" onclick="stopPrizeClose()" style="display: none;">
        <!-- 卡券显示 -->
        <div class="mePrize-copone-yes-code  mePrize-copone-content rules-show-content hasCode" style="display: none;">
          <div>
            <!-- 卡券图片 -->
            <div class="mePrize-coupon-code-img">
              <img src="./image/code-img.png" alt=""/>
            </div>
            <div class="mePrize-coupon-code-txt">
              可线上购买蛋糕(限西安市内)、电影票、网络视听会员、图书等
            </div>
            <!-- 商家二维码 -->
            <div class="mePrize-coupon-code" >
              <p>扫描下方商家二维码 了解更多使用详情</p>
              <img src="./image/code.png" alt="中福尚优" />
            </div>
          </div>
          <img src="./image/close.png" alt="close" id="close-box" class="close-1" onclick="closeMePrize()"/>
        </div> 
        <!-- 卡券显示/卡券密码显示 -->
        <div class="mePrize-coupon-ma hasCode" style="display: none;">
          <span>卡券编码:</span>
          <p id="codeNumbox">卡券编码显示位</p>
        </div> 
        <div class="mePrize-coupon-ma hasCode" style="display: none;">
          <span>卡券密码:</span>
          <p id="codePwdBox">卡券密码显示</p>
        </div>
        <div class="mePrize-coupon-code-explain hasCode" style="display: none;">
          <h3>卡券绑定</h3>
          <p>微信关注中福尚优公众号-进入我的卡券-绑定卡券-输入账号密码绑定卡券-绑定成功</p>
        </div>
        <div class="mePrize-coupon-title hasCode" style="display: none;">
          <img src="./image/code-title.png" />
        </div>
        <!-- 卡券说明 -->
        <div class="mePrize-coupon-rules rules-show-content hasCode" style="display: none;" >
          <div class="mePrize-copone-rules-txt">
            <!-- <h3>活动说明:</h3> -->
            <ul>
              <li class="li-title">
                方式一: 线上福利平台
              </li>
              <li class="li-content">可线上购买蛋糕(限西安市内)、电影票、网络视听会员、图书等</li>
              <li class="li-title">
                方式二: 线下店内购买
              </li>
              <li class="li-content">持绑定卡券至陕西省内米旗,御品轩,帕芙琳,面包新语,塞拉维的所有门店,可用微信扫描商户二维码进行购买,店内产品没有限制。</li>
              
              
            </ul>
          </div>
        </div>
       
        <!-- 非卡券显示 -->
        <div class="mePrize-copone-content rules-show-content mePrize-copone-no-code noCode" style="display: none;">
          <img src="./image/close.png" alt="close" id="close-box" class="close-1" onclick="closeMePrize()"/>
          <div class="mePrize-copone-imges" id="noCodeImage"></div>
        </div>
        <div class="mePrize-coupon-rules-goods-txt noCode" style="display: none;">
          <h3>派送方式</h3>
          <p>直播结束三日后, 银行工作人员将会致电,确认无误后会根据所填地址进行邮寄。</p>
        </div>
        
      </div>
      
    </div>
  </div>
 
  
  <script src="./js/flexible/flexible.js"></script>
  <script src="./js/tool/ios.js"></script>
  <script src="./js/loading/index.js"></script>
  <script src="./js/tool/CryptoJS.min.js"></script>
  <script src="./js/tool/secret.js"></script>
  <script src="./js/tool/axios.min.js"></script>
 
  <!-- 登录 -->
  <!-- <script src="./js/home/login.js"></script> -->
  <!-- 首页api -->
  <script src="./js/home/index.js"></script>

  <script>
     window.onload = () =>{
      // 全局提示
      let allMsg =  new getMessage('');
      getPieList();
      userBout();
      getHasRanking();
      getMePrizeHttp();
    }
    // loading 关闭
    function  closeLoading() {
      document.querySelector('.loading').style.display = 'none';
    }
    // 转盘部分 
    let pieData = []; //转盘奖品数据
    // -----  游戏 ------
    let prizeList = [];     //奖品数据
    let prizeNum = 6 ;      //奖品数量
    let userBoutNum = 0 ;     //用户可用游戏次数
    let userFlag = true ;   //用户是否可以玩
    let asyncData = '' ;    //中奖数据
    let isPointer = false;  //是否指针旋转
    let rotateStyle = '';   //转盘旋转样式
    let pointerStyle = '';  //指针旋转样式
    let fixCircle = 6 ;     //转盘固定旋转圈数
    let pointerCircle = 6 ; //指针固定旋转圈数
    let flag = true ;       //节流
    let winIndex = 1 ;      // 中间索引 （下标）
    let preDeg = 0 ;        //上次游戏转盘旋转角度
    // -----  游戏 ------
    // 我的奖品
    let isQuan = false ; //是否是奖券
    let isMeHasPrize = false ; //是否获取奖品

    // 获取转盘奖品列表
    function getPieList(){
      getWheelPrize('2').then(res => {
        let datas = JSON.parse(Decrypt(res.data));
        if(datas.code == '0' ){
          pieData = datas.data;
          console.log(datas,"奖品列表")
          let obj = {
            id:0,
            imageUrl: './image/05.png',
            name:'谢谢参与'
          }
          pieData.unshift(obj);
          pieData.splice(3,0,obj)
          createPrizeList(domPie,prizeNum,datas.data);
        }
      })
    }
    
    // 中奖元素添加
    let domPie = document.getElementById('pieDisc');
    // 生成奖品
    function createPrizeList (domPie,w,data) {
      let R = Number(window.getComputedStyle(domPie,null).width.slice(0, -2));
      let deg = Math.PI/w ;
      let Deg_t = 360/w ;
      let WIDTH = R*Math.sin(deg);
      for(let i = 0 ; i<w ; i++){
        let rotateDeg = Deg_t*i;
        let images,html;
        if(!data){
          alert("请求异常！请退出刷新");
        }else{
            images = data[i].imageUrl;
            html = `<span>${data[i].name}</span>
                    <img src="${images}" />`
        }
        
        
        let domItem = document.createElement('div');
        domItem.classList.add('pie-prize');
        domItem.style.width = WIDTH-30 + "px";
        domItem.style.transform =  "rotate("+ rotateDeg +"deg)";
        domItem.innerHTML = html ; 
        domPie.appendChild(domItem);
      }
      closeLoading();
    }
    // 当前 用户可用游戏次数
    function userBout(){
      let PlayBout = document.querySelector('.play-bout');
      userPlayRounds().then(res =>{
        console.log(JSON.parse(Decrypt(res.data)),"游戏次数");
        let datas = JSON.parse(Decrypt(res.data));
        userBoutNum = datas.data;
        PlayBout.innerText = datas.data;
      })
    }
    
    // 用户抽奖
    async function userPlayGame(){
      let a =  await playStart().then(res=>{
        console.log(JSON.parse(Decrypt(res.data)))
        return JSON.parse(Decrypt(res.data)).data
      })
      return a 
    }

    // 遮罩元素
    let MaskDom = document.getElementById("maskId");
    function MaskClose() {
      event.currentTarget.style.display = 'none';
      document.body.classList.remove('body-disabled');
      let pieDiscDom = document.getElementById('pieDisc');
      if(flag){
        if(isPointer){
          startDom.style.transform = "rotate("+ preDeg +"deg)";
        }else{
          pieDiscDom.style.transform = "rotate("+ preDeg +"deg)";
        }
      }
    }
    MaskDom.addEventListener('click',MaskClose,false)
    // 活动规则 中奖名单显示 消息提示
    let rulesShow = document.getElementById('rules_show');     // 活动规则
    let rankingShow = document.getElementById('ranking_show'); // 排行榜
    let noChance = document.getElementById('no_chance');       // 没有游戏机会
    let mePrize = document.getElementById('me_prize');         // 我的奖品
    // 活动规则
    let rulesDom = document.getElementById('rules');
    rulesDom.onclick = () => {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'block';
      rankingShow.style.display = 'none';
      noChance.style.display = 'none';
      mePrize.style.display = 'none';
      document.body.classList.add('body-disabled');
    }

    // 我的奖品
    function getMePrize() {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'none';
      rankingShow.style.display = 'none';
      noChance.style.display = 'none';
      mePrize.style.display = 'flex';
      document.body.classList.add('body-disabled');
    }
    // 我的奖品阻止冒泡
    function stopPrizeClose() {
      event.stopPropagation();
    }
    // 关闭我的奖品 
    function closeMePrize() {
      mePrize.style.display = 'none';
      MaskDom.style.display = 'none';
      document.body.classList.remove('body-disabled');
    }
    // 获取我的奖品
    function  getMePrizeHttp() {
      userPrize().then(res=>{
        let isMePrizeRepouest = JSON.parse(Decrypt(res.data));
        let isMePrizeData = isMePrizeRepouest.data;
        console.log(isMePrizeRepouest)
        if(isMePrizeRepouest.code !== 0) {
          allMsg.msg = isMePrizeRepouest.message;
          allMsg.show();
          return ;
        }
        if(isMePrizeData && isMePrizeData.length>0){
          isMeHasPrize = true
          isQuan = isMePrizeData[1].code? true : false ;
          showPrize(isMePrizeData[1]);
        }
      })
    }
    // 显示普通奖品 /  奖券
    function showPrize(data) {
      let noPrize = document.querySelector('.noHasMePrize') // 没有获得奖品
      let hasPrize = document.querySelector('.hasMePrize'); // 有获得奖品
      let isCodeShow = document.getElementsByClassName('hasCode'); // 是奖券
      isCodeShow = [...isCodeShow];
      let isNoCodeShow = document.getElementsByClassName('noCode'); // 是普通奖品
      isNoCodeShow = [...isNoCodeShow];

      let isCodeNum = document.getElementById('codeNumbox'); //卡券编码
      let isCodePwd = document.getElementById('codePwdBox'); //卡券密码
      let NoCodeImage = document.getElementById('noCodeImage');//非卡券显示图片

      if(isMeHasPrize){
        noPrize.style.display = 'none';
        hasPrize.style.display = 'block';
        if(isQuan){
            isCodeShow.forEach(item=>{
              item.style.display = 'block';
              if(item.classList.contains('mePrize-coupon-ma')){
                item.style.display = 'flex';
              }
            })
            isNoCodeShow.forEach(item => {
              item.style.display = 'none'
            })
            isCodeNum.innerText = data.code;
            isCodePwd.innerText = data.pwd;
        }else{
            NoCodeImage.innerHTML = `<img src="${data.realUrl}" />`
            isCodeShow.forEach(item=>{
              item.style.display = 'none'
            })
            isNoCodeShow.forEach(item => {
            item.style.display = 'block'
          })
        }
      }else {
        noPrize.style.display = 'block';
        hasPrize.style.display = 'none';
      }
      
      
    }
    

    // 中奖名单 
    let rankingDom = document.getElementById('ranking');
    rankingDom.onclick = () => {
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'none';
      rankingShow.style.display = 'block';
      noChance.style.display = 'none';
      mePrize.style.display = 'none';
      document.body.classList.add('body-disabled');
    }

    // 获取中奖名单
    function getHasRanking () {
      userRanking().then(res => {
        let datas = JSON.parse(Decrypt(res.data)) 
        console.log(JSON.parse(Decrypt(res.data)),"排行榜")
        readHasRanking(datas.data);
      })
    }
    // 渲染排行榜
    function readHasRanking(data) {
      let rankingList = document.getElementById('ranking-list');
      if(data &&  data.length>0){
        for(let i = 0 ; i< data.length ; i++) {
          let name = data[i].name;
          let phone = data[i].tel ||'xxxx';
          let prizeName = data[i].prizeName;
          let html = `<li>
            <span>${name}</span>
            <span>${phone}</span>
            <span>${prizeName}</span>
          </li>`;
          rankingList.innerHTML += html;
        }
      }else {
        rankingList.innerHTML = `<li style="justify-content: center;">
          <span>暂无数据</span></li>`
      }
    }
    
    
      
    // 获取当前用户游戏次数
    function getUserCount(){
      if(userBoutNum<1){
        userFlag = false;
        flag = false;
        // 显示游戏次数不足
        msgWindow('您的游戏机会已用完');
      }else{
        userFlag = true;
      }
    }
    // 点击旋转按钮
    async function  hanldStart() {
      getUserCount();
      if(!flag) return;
      flag = false;
      let index = await userPlayGame()
      // winIndex = index >= 0 &&  index !== undefined ? index : Math.floor(Math.random()*prizeNum);
      let winIndexId = index >= 0 &&  index !== undefined ? index : 2;
      
      pieData.forEach((item,inx) => {
        if(winIndexId == 0) {
          winIndex = Math.floor(Math.random()*2)? 3 : 0;
          return
        }
        if(item.id == winIndexId) {
          winIndex = inx
        }
      })
      console.log(winIndex, index >= 0 ,index)
      pieMoveMent();
      userBout();
      getHasRanking();
    }
    // 计算旋转圈数角度
    function  countDeg(index) {
      let cycles = isPointer? pointerCircle : fixCircle;
      cycles*=360;
      // 旋转角度
      
      let cyclesDeg = ( 360/prizeNum )*index + cycles + preDeg ;
      // 记录角度
      preDeg = ( 360/prizeNum )*( prizeNum - index) + cyclesDeg;

      return cyclesDeg;
    }
    // 转盘运动
    function pieMoveMent(){
      let startDom = document.getElementById('btnStart');
      let pieDiscDom = document.getElementById('pieDisc');

      pieDiscDom.style.transition = "transform ease 4s";
      if(isPointer) {
        startDom.style.transition = "transform ease 4s";
        startDom.style.transform = "rotate("+ countDeg(winIndex) +"deg)"+"scale(0.9)";
      }else {
        pieDiscDom.style.transform = "rotate("+ countDeg(prizeNum-winIndex) +"deg)";
      }
      setTimeout(()=>{
        pieDiscDom.style.transition = 'none';
        startDom.style.transition = 'none';
        flag = true;
        let msg ;
        if(winIndex === 0 || winIndex === 3) {
          msg = '您差一点获得奖品...'
        }else {
          msg = '恭喜您获得' + pieData[winIndex].name +`<br/> <p>即将跳转至领奖界面,请勿返回<p>` ;
          setTimeout(()=>{
            location.href = './addFilling.html?id='+pieData[winIndex].id ;
          },1000);
          MaskDom.removeEventListener('click',MaskClose,false)
        }
        msgWindow(msg);
      },4100)
    }
    // 提示弹框
    function msgWindow(msg) {
      noChance.innerHTML = ` <div class="no-chance-content rules-show-content">
      <div class="no-chance-txt rules-show-txt">${msg}</div>
    </div>
    <img src="./image/close.png" alt="close" id="close-box" class="close-1" />
    <img src="./image/red-box-3.png" alt="红包3" class="red-box-1">
    <img src="./image/red-box-4.png" alt="红包4" class="red-box-2">`
      MaskDom.style.display = 'block';
      rulesShow.style.display = 'none';
      rankingShow.style.display = 'none';
      noChance.style.display = 'block';
      mePrize.style.display = 'none';
      document.body.classList.add('body-disabled');
    }
   


  </script>
</body>
</html>